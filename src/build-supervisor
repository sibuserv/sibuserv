#!/bin/bash

# User configuration file: ~/.config/sibuserv/sibuserv.conf
# System configuration file: /etc/sibuserv/sibuserv.conf

##### Default settings #####

# Number of compilation processes:
[ -z "${JOBS}" ] && export JOBS=4

export BUILD_SERVER_SRC_DIRS="${HOME}/BuildServer/Sources"
export BUILD_SERVER_BIN_DIR="${HOME}/BuildServer/Binaries"
export BUILD_SERVER_LOG_FILE="${BUILD_SERVER_BIN_DIR}/build-server-daemon.log"

export STATIC_CODE_ANALYSIS_LOGS_SUBDIR="StaticCodeAnalysis"
export ENABLE_STATIC_CODE_ANALYSIS="true"
export ENABLE_CPPCHECK_LOG="true"
export ENABLE_CPPCHECK_XML="true"
export ENABLE_CPPCHECK_HTML="true"
export CPPCHECK_OPTIONS="-v -f -j${JOBS} --enable=style --suppress=variableScope"

SYSTEMS="i686-w64-mingw32.static
         x86_64-w64-mingw32.static
         Ubuntu-14.04-LTS_i386_static
         Ubuntu-14.04-LTS_amd64_static
         android_x86
         android_armv7"


##### Do not edit lines below! #####

##### Load settings from configuration file if it exists #####

for CONF_FILE in "/etc/sibuserv/sibuserv.conf" \
                 "${HOME}/.config/sibuserv/sibuserv.conf"
do
    [ -r "${CONF_FILE}" ] && . "${CONF_FILE}" || true
done

##### Some tools #####

GetLastBuiltVersion()
{
    mkdir -p "${BUILD_SERVER_BIN_DIR}/${PROJECT}"
    cd "${BUILD_SERVER_BIN_DIR}/${PROJECT}"
    BUILD_VER=$(ls 2> /dev/null | sort -V | tail -n1)
}

GetCurrentVersion()
{
    cd "${SOURCES_DIR}/${PROJECT}"
    CURRENT_VER="unknown-version"
    if [ -d ".git" ]
    then
        if [ -d ".git/svn" ]
        then
            git svn rebase &> /dev/null
            CURRENT_VER=$(LANG=C git svn info 2> /dev/null | sed -ne "s|^Last Changed Rev: \(.*\)|\1|p")
        elif [ -d ".git/hg" ]
        then
            # git-remote-hg is used
            git pull --all &> /dev/null
            CURRENT_VER="$(TZ=UTC git show -s --pretty='format:%ad__%h' --date=format-local:'%Y%m%d-%H%M%S')"
        else
            git pull --all &> /dev/null
            if git describe --tags &> /dev/null
            then
                CURRENT_VER="$(git describe --tags)"
            else
                CURRENT_VER="$(TZ=UTC git show -s --pretty='format:%ad__%h' --date=format-local:'%Y%m%d-%H%M%S')"
            fi
        fi
    elif [ -d ".hg" ]
    then
        hg pull &> /dev/null
        hg update &> /dev/null
        CURRENT_VER="$(TZ=UTC hg log --limit 1 -T '{date(date|localdate,"%Y%m%d-%H%M%S")}__{node|short}\n' | head -n1)"
    elif [ -d ".svn" ]
    then
        svn up &> /dev/null
        CURRENT_VER="$(LANG=C svn info 2> /dev/null | sed -ne 's|^Last Changed Rev: \(.*\)|\1|p')"
    else
        CURRENT_VER="$(TZ=UTC date -d @$(stat -c'%Y' .) '+%Y%m%d-%H%M%S')"
    fi
}

PrepareProjectBuild()
{
    export BUILD_DIR="/home/boris/BuildServer/${PROJECT}/${CURRENT_VER}"
    if [ ! -d "${BUILD_DIR}" ]
    then
        mkdir "${BUILD_DIR}"
    else
        return 1
    fi
}

BeginProjectBuild()
{
    echo "$(date +"[%Y-%m-%d %H:%M:%S]") build: ${PROJECT}: ${CURRENT_VER}" &>> "${BUILD_SERVER_LOG_FILE}"
}

EndProjectBuild()
{
    echo "$(date +"[%Y-%m-%d %H:%M:%S]") done:  ${PROJECT}: ${CURRENT_VER}" &>> "${BUILD_SERVER_LOG_FILE}"
}

IsQmakeProject()
{
    [ $(grep qmake "${BUILD_DIR}"/*/Makefile 2> /dev/null | wc -l) != "0" ] && \
        return 0 || \
        return 1
}

IsCmakeProject()
{
    [ $(ls "${BUILD_DIR}"/*/CMakeCache.txt 2> /dev/null | wc -l) != "0" ] && \
        return 0 || \
        return 1
}

IsAutotoolsProject()
{
    [ $(ls "${BUILD_DIR}"/*/config.status 2> /dev/null | wc -l) != "0" ] && \
        return 0 || \
        return 1
}

InstallQmakeProject()
{
    cd "${SOURCES_DIR}/${PROJECT}"
    build-project clean ${SYSTEMS} &> /dev/null

    cd "${BUILD_DIR}"
    find "${BUILD_DIR}" -type f \
        -name '*object_script*' -o \
        -name '*Makefile*' -o \
        -name '*.cpp' -o \
        -name '*.h' | \
        while read F; do rm -f "${F}"; done
    find "${BUILD_DIR}" -type f \
        -name '*.a' | \
        while read F; do rm -f "${F}"; done
    find "${BUILD_DIR}" -type d \
        -name '*android-build*' | \
        while read F; do rm -rf "${F}"; done
    find "${BUILD_DIR}" -type f | \
        grep '.*android_.*\.so' | \
        while read F; do rm -f "${F}"; done
    for S in *
    do
        [ "${S}" = "${STATIC_CODE_ANALYSIS_LOGS_SUBDIR}" ] && continue || true

        find "${BUILD_DIR}/${S}" -type f | \
            while read F; do mv "${F}" "${S}/" 2> /dev/null; done
    done
    find "${BUILD_DIR}" -depth -empty -delete
}

InstallCmakeProject()
{
    cd "${BUILD_DIR}"
    for S in *
    do
        [ "${S}" = "${STATIC_CODE_ANALYSIS_LOGS_SUBDIR}" ] && continue || true

        cd "${BUILD_DIR}/${S}"
        make install DESTDIR="${BUILD_DIR}/${S}-out" -j1 -i -k &> /dev/null
        [ ! -d "${BUILD_DIR}/${S}-out" ] && mkdir "${BUILD_DIR}/${S}-out" || true
        cp -af *.log "${BUILD_DIR}/${S}-out" &> /dev/null

        cd "${BUILD_DIR}"
        rm -rf "${BUILD_DIR}/${S}" &> /dev/null
        mv "${BUILD_DIR}/${S}-out" "${BUILD_DIR}/${S}" &> /dev/null
    done
}

InstallAutotoolsProject()
{
    cd "${BUILD_DIR}"
    for S in *
    do
        [ "${S}" = "${STATIC_CODE_ANALYSIS_LOGS_SUBDIR}" ] && continue || true

        cd "${BUILD_DIR}/${S}"
        make install DESTDIR="${BUILD_DIR}/${S}-out" -j1 -i -k &> /dev/null
        [ ! -d "${BUILD_DIR}/${S}-out" ] && mkdir "${BUILD_DIR}/${S}-out" || true
        cp -af *.log "${BUILD_DIR}/${S}-out" &> /dev/null

        cd "${BUILD_DIR}"
        rm -rf "${BUILD_DIR}/${S}" &> /dev/null
        mv "${BUILD_DIR}/${S}-out" "${BUILD_DIR}/${S}" &> /dev/null
    done
}

StartStaticCodeAnalysis()
{
    cd "${SOURCES_DIR}/${PROJECT}"
    if [ "${ENABLE_STATIC_CODE_ANALYSIS}" != "true" ]
    then
        return 0
    fi

    STATIC_CODE_ANALYSIS_LOGS_DIR="${BUILD_DIR}/${STATIC_CODE_ANALYSIS_LOGS_SUBDIR}"
    mkdir -p "${STATIC_CODE_ANALYSIS_LOGS_DIR}"

    if [ "${ENABLE_CPPCHECK_LOG}" = "true" ] && \
       [ $(which cppcheck | wc -l) = "1" ]
    then
        LOG_FILE="${STATIC_CODE_ANALYSIS_LOGS_DIR}/cppcheck.log"
        cppcheck -q ${CPPCHECK_OPTIONS} . &> "${LOG_FILE}"
        STAT_FILE="${STATIC_CODE_ANALYSIS_LOGS_DIR}/cppcheck.stats.txt"
        grep ': (' "${LOG_FILE}" | tr '()' '*' | cut -d* -f2 | sort | uniq -c &> "${STAT_FILE}"
    fi
    if [ "${ENABLE_CPPCHECK_XML}" = "true" ] && \
       [ $(which cppcheck | wc -l) = "1" ]
    then
        XML_FILE="${STATIC_CODE_ANALYSIS_LOGS_DIR}/cppcheck.xml"
        cppcheck -q ${CPPCHECK_OPTIONS} --xml . &> "${XML_FILE}"
    fi
    if [ "${ENABLE_CPPCHECK_HTML}" = "true" ] && \
       [ "${ENABLE_CPPCHECK_XML}"  = "true" ] && \
       [ $(which cppcheck-htmlreport | wc -l) = "1" ] && \
       [ -r "${XML_FILE}" ]
    then
        HTML_DIR="${STATIC_CODE_ANALYSIS_LOGS_DIR}/cppcheck.html"
        cppcheck-htmlreport --source-dir=. --report-dir="${HTML_DIR}" --file="${XML_FILE}" \
                            &> "${STATIC_CODE_ANALYSIS_LOGS_DIR}/cppcheck.html.log"
    fi
}

ProcessProject()
{
    GetLastBuiltVersion
    GetCurrentVersion

    if [ "${BUILD_VER}" != "${CURRENT_VER}" ]
    then
        PrepareProjectBuild || continue
        BeginProjectBuild

        cd "${SOURCES_DIR}/${PROJECT}" || exit 1
        build-project ${SYSTEMS} &> /dev/null

        if IsAutotoolsProject
        then
            InstallAutotoolsProject
        elif IsCmakeProject
        then
            InstallCmakeProject
        elif IsQmakeProject
        then
            InstallQmakeProject
        fi

        StartStaticCodeAnalysis
        EndProjectBuild
    fi
}

##### Script body #####

export DELIMITER=":"
while [ "${BUILD_SERVER_SRC_DIRS}" ]
do
    export SOURCES_DIR="${BUILD_SERVER_SRC_DIRS%%${DELIMITER}*}"
    if [ "${BUILD_SERVER_SRC_DIRS}" != "${SOURCES_DIR}" ]
    then
        BUILD_SERVER_SRC_DIRS="${BUILD_SERVER_SRC_DIRS#*${DELIMITER}}"
    else
        export BUILD_SERVER_SRC_DIRS=""
    fi

    [ ! -d "${SOURCES_DIR}" ] && continue || true
    cd "${SOURCES_DIR}"

    [ "$(ls | wc -l)" = "0" ] && continue || true
    for PROJECT in *
    do
        [ -d "${SOURCES_DIR}/${PROJECT}" ] && ProcessProject || true
    done
done

